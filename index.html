<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì –†–∞–∑–¥–µ–ª–∏—Ç—å –∫–ª–∞—Å—Å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã</title>
    <style>
        :root {
            --bg-body: #f9f9fb;
            --bg-container: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #34495e;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --btn-bg: #3498db;
            --btn-hover: #2980b9;
            --team-bg: #e3f2fd;
            --team-border: #2196f3;
            --error-bg: #fdf2f2;
            --error-border: #e74c3c;
            --error-text: #e74c3c;
            --info-bg: #f1f8e9;
            --info-text: #2e7d32;
            --select-bg: #ffffff;
            --warning-bg: #fff8e1;
            --warning-border: #ffc107;
            --warning-text: #5d4037;
            --checkbox-bg: #fff;
            --checkbox-border: #ccc;
            --checkbox-checked-bg: #3498db;
        }

        .dark-theme {
            --bg-body: #121212;
            --bg-container: #1e1e1e;
            --text-primary: #f0f0f0;
            --text-secondary: #e0e0e0;
            --border-color: #444;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
            --btn-bg: #1e88e5;
            --btn-hover: #1565c0;
            --team-bg: #1e3a5f;
            --team-border: #4fc3f7;
            --error-bg: #3d2323;
            --error-border: #c62828;
            --error-text: #ef9a9a;
            --info-bg: #2e3b2a;
            --info-text: #a5d6a7;
            --select-bg: #2d2d2d;
            --warning-bg: #332a20;
            --warning-border: #d4af37;
            --warning-text: #e6c39c;
            --checkbox-bg: #333;
            --checkbox-border: #555;
            --checkbox-checked-bg: #1e88e5;
        }

        * {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 30px 20px;
            background-color: var(--bg-body);
            color: var(--text-primary);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--bg-container);
            padding: 25px;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        h1 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-top: 20px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        input[type="number"], select {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            background-color: var(--select-bg);
            color: var(--text-primary);
        }

        button {
            background: var(--btn-bg);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
            transition: background 0.3s;
        }

        button:hover {
            background: var(--btn-hover);
        }

        .team {
            margin-top: 20px;
            padding: 16px;
            background: var(--team-bg);
            border-left: 5px solid var(--team-border);
            border-radius: 0 6px 6px 0;
            color: var(--text-primary);
        }

        .error, .warning {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }
        .error {
            color: var(--error-text);
            background: var(--error-bg);
            border-left: 4px solid var(--error-border);
        }
        .warning {
            color: var(--warning-text);
            background: var(--warning-bg);
            border-left: 4px solid var(--warning-border);
            font-size: 0.95em;
        }

        .info-box {
            background: var(--info-bg);
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.95em;
            color: var(--info-text);
        }

        .subject-title {
            color: var(--text-primary);
            font-weight: bold;
        }

        #results {
            margin-top: 30px;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(128, 128, 128, 0.1);
            color: var(--text-primary);
        }

        /* –ß–µ–∫–±–æ–∫—Å—ã */
        .absent-list {
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            background: var(--select-bg);
        }

        .absent-group {
            margin-bottom: 12px;
        }

        .absent-group-title {
            font-weight: 600;
            margin: 8px 0 4px;
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .absent-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 8px;
        }

        .absent-item {
            display: flex;
            align-items: center;
            margin: 2px 0;
        }

        .absent-item input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            background-color: var(--checkbox-bg);
            border: 1px solid var(--checkbox-border);
            border-radius: 4px;
            accent-color: var(--checkbox-checked-bg); /* –¥–ª—è modern –±—Ä–∞—É–∑–µ—Ä–æ–≤ */
        }

        .absent-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
            user-select: none;
        }

        /* Search */
        .search-box {
            margin-top: 10px;
            position: relative;
        }
        .search-box input {
            padding-left: 32px;
        }
        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        @media (max-width: 600px) {
            .container { padding: 15px; }
            h1 { font-size: 1.8rem; }
            .absent-items { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <button id="themeToggle" class="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
        üåû
    </button>

    <div class="container">
        <h1>üéì –†–∞–∑–¥–µ–ª–∏—Ç—å –∫–ª–∞—Å—Å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã</h1>

        <form id="teamForm">
            <label for="subject">üìö –ü—Ä–µ–¥–º–µ—Ç:</label>
            <select id="subject" name="subject" required>
                <option value="geo">–ì–µ–æ–≥—Ä–∞—Ñ–∏—è</option>
            </select>

            <label for="teams_count">üî¢ –ß–∏—Å–ª–æ –∫–æ–º–∞–Ω–¥:</label>
            <input type="number" id="teams_count" name="teams_count" value="3" min="1" required>

            <label for="absentSearch">üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="absentSearch" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è...">
            </div>

            <label>‚ùå –û—Ç–º–µ—Ç—å—Ç–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö:</label>
            <div class="absent-list" id="absentList">
                <!-- –ß–µ–∫–±–æ–∫—Å—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>

            <button type="submit">–†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã</button>
        </form>

        <div id="error" class="error"></div>
        <div id="warning" class="warning"></div>
        <div id="results"></div>
    </div>

    <script>
        // === –¢–µ–º–∞ ===
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches;
        let currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');

        function applyTheme(theme) {
            if (theme === 'dark') {
                body.classList.add('dark-theme');
                themeToggle.textContent = 'üåô';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark-theme');
                themeToggle.textContent = 'üåû';
                localStorage.setItem('theme', 'light');
            }
        }
        applyTheme(currentTheme);
        themeToggle.addEventListener('click', () => {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(currentTheme);
        });
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) applyTheme(e.matches ? 'dark' : 'light');
            });
        }

        // === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
        function shuffleArrayInPlace(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }
        function shuffleArray(arr) {
            const copy = [...arr];
            shuffleArrayInPlace(copy);
            return copy;
        }

        function getAdjustedTeamsCount(availableCount, requested) {
            if (availableCount <= 1) return 1;
            if (availableCount === 2) return 1;
            if (availableCount === 3) return Math.min(requested, 2);
            return Math.min(requested, Math.floor(availableCount / 2));
        }

        function balanceTeams(teams) {
            teams = teams.filter(team => team.length > 0);
            let changed;
            do {
                changed = false;
                const sizes = teams.map(t => t.length);
                const maxIdx = sizes.indexOf(Math.max(...sizes));
                const minIdx = sizes.indexOf(Math.min(...sizes));
                if (teams[maxIdx].length >= 3 && teams[minIdx].length <= 1) {
                    const person = teams[maxIdx].pop();
                    teams[minIdx].push(person);
                    changed = true;
                }
            } while (changed);
            return teams;
        }

        function getRandomMinTeamIndex(teams) {
            const minLength = Math.min(...teams.map(t => t.length));
            const minIndices = teams.map((t, i) => t.length === minLength ? i : -1).filter(i => i !== -1);
            return minIndices[Math.floor(Math.random() * minIndices.length)];
        }

        // === –î–∞–Ω–Ω—ã–µ ===
        const SUBJECTS_DATA = {
            geo: {
                name: '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è',
                people: [
                    '–ê –ê–ª—å—Ñ–∏–Ω–∞ –ê.', '–ê –ú–∏–ª–∞–Ω–∞ –ê', '–ê –ï–≤–∞ –≠', '–ê –ê–ª–µ–∫—Å–µ–π –ê', '–ë –î–º–∏—Ç—Ä–∏–π –î',
                    '–í –ú–∏—Ä—Ä–∞ –ü', '–ì –Ø—Ä–æ—Å–ª–∞–≤ –û', '–ì –ö—Å–µ–Ω–∏—è –ê', '–î –ò–≤–∞–Ω –î', '–î –ù–∞–¥–µ–∂–¥–∞ –ò',
                    '–ñ –õ–∞–≤—Ä–µ–Ω—Ç–∏–π –ê', '–ó –í–∞–ª–µ—Ä–∏—è –ê', '–ö –ê–Ω–¥—Ä–µ–π –ù', '–§–∏–ª–∏–ø –û. –ö', '–ö –Ø—Ä–æ—Å–ª–∞–≤ –î',
                    '–õ –î–∞—Ä—å—è –ò', '–ú –ê–Ω–∞—Å—Ç–∞—Å–∏—è –°', '–û –ü–∞–≤–µ–ª –ò', '–° –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –Æ', '–° –î–∞–Ω–∏–∏–ª –°',
                    '–° –†–æ–º–∞–Ω –°', '–° –§–µ–¥–æ—Ä –ú', '–Æ –î–∞—Ä—å—è –ò', '–Ø –ú–∞—Ç–≤–µ–π –í'
                ],
            }
        };

        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–µ—Ä–≤–æ–π –±—É–∫–≤–µ —Ñ–∞–º–∏–ª–∏–∏ (–ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞ —Å—Ç—Ä–æ–∫–∏)
        function groupPeopleByFirstLetter(people) {
            const groups = {};
            people.forEach(name => {
                const letter = name.charAt(0).toUpperCase();
                if (!groups[letter]) groups[letter] = [];
                groups[letter].push(name);
            });
            return Object.keys(groups).sort().map(letter => ({
                letter,
                people: groups[letter].sort()
            }));
        }

        // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ ===
        function renderAbsentCheckboxes(subjectKey) {
            const subject = SUBJECTS_DATA[subjectKey];
            const container = document.getElementById('absentList');
            const groups = groupPeopleByFirstLetter(subject.people);

            let html = '';
            groups.forEach(group => {
                html += `<div class="absent-group">
                    <div class="absent-group-title">${group.letter}</div>
                    <div class="absent-items">`;
                group.people.forEach(name => {
                    const id = `absent_${name.replace(/\s+/g, '_').replace(/[^\w]/g, '')}`;
                    html += `
                        <div class="absent-item">
                            <input type="checkbox" id="${id}" name="absent" value="${name}">
                            <label for="${id}">${name}</label>
                        </div>`;
                });
                html += `</div></div>`;
            });
            container.innerHTML = html;

            // –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–æ–∏—Å–∫
            setupSearchFilter();
        }

        function setupSearchFilter() {
            const searchInput = document.getElementById('absentSearch');
            const checkboxes = document.querySelectorAll('#absentList input[type="checkbox"]');
            const labels = document.querySelectorAll('#absentList label');

            searchInput.addEventListener('input', () => {
                const query = searchInput.value.trim().toLowerCase();
                checkboxes.forEach((cb, i) => {
                    const label = labels[i];
                    const name = label.textContent.toLowerCase();
                    const isVisible = name.includes(query);
                    cb.parentElement.style.display = isVisible ? 'flex' : 'none';
                });
            });
        }

        function divideIntoTeamsWithPairs(people, teamsCount) {
            const peopleSet = new Set(people);
            const teams = Array.from({ length: teamsCount }, () => []);
            let remaining = [...people];

            const shuffledRemaining = shuffleArray(remaining);
            for (const person of shuffledRemaining) {
                const teamIdx = getRandomMinTeamIndex(teams);
                teams[teamIdx].push(person);
            }

            for (const team of teams) {
                shuffleArrayInPlace(team);
            }

            return balanceTeams(teams);
        }

        // === UI ===
        function showError(message) {
            document.getElementById('error').textContent = `‚ö†Ô∏è –û—à–∏–±–∫–∞: ${message}`;
            document.getElementById('error').style.display = 'block';
            document.getElementById('warning').style.display = 'none';
        }
        function showWarning(message) {
            document.getElementById('warning').textContent = `‚ÑπÔ∏è ${message}`;
            document.getElementById('warning').style.display = 'block';
        }
        function hideMessages() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('warning').style.display = 'none';
        }
        function renderTeams(teams, subjectName) {
            document.getElementById('results').innerHTML = `
                <h2>‚úÖ –ö–æ–º–∞–Ω–¥—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É: <em>${subjectName}</em></h2>
                ${teams.map((team, i) => `
                    <div class="team">
                        <strong>üîπ –ö–æ–º–∞–Ω–¥–∞ ${i + 1} (${team.length}):</strong><br>
                        ${team.join(', ')}
                    </div>
                `).join('')}
            `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        renderAbsentCheckboxes('geo');

        document.getElementById('subject').addEventListener('change', function() {
            renderAbsentCheckboxes(this.value);
        });

        document.getElementById('teamForm').addEventListener('submit', e => {
            e.preventDefault();
            hideMessages();

            const subjectKey = document.getElementById('subject').value;
            let teamsCount = parseInt(document.getElementById('teams_count').value);

            if (isNaN(teamsCount) || teamsCount < 1) return showError('–ß–∏—Å–ª–æ –∫–æ–º–∞–Ω–¥ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚â• 1');
            const subject = SUBJECTS_DATA[subjectKey];
            if (!subject) return showError('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç');

            // üî• –°–±–æ—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —á–µ—Ä–µ–∑ —á–µ–∫–±–æ–∫—Å—ã
            const checkedBoxes = document.querySelectorAll('#absentList input[type="checkbox"]:checked');
            const absentList = Array.from(checkedBoxes).map(cb => cb.value);
            const available = subject.people.filter(p => !absentList.includes(p));
            const availableCount = available.length;

            if (availableCount === 0) return showError('–ù–µ–∫–æ–≥–æ –¥–µ–ª–∏—Ç—å ‚Äî –≤—Å–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.');

            const maxAllowed = getAdjustedTeamsCount(availableCount, teamsCount);
            if (teamsCount > maxAllowed) {
                const oldCount = teamsCount;
                teamsCount = maxAllowed;
                showWarning(
                    `–ß–∏—Å–ª–æ –∫–æ–º–∞–Ω–¥ —É–º–µ–Ω—å—à–µ–Ω–æ —Å ${oldCount} –¥–æ ${teamsCount}, ` +
                    `—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–º–∞–Ω–¥ —Å 0‚Äì1 —É—á–∞—Å—Ç–Ω–∏–∫–æ–º. –ú–∞–∫—Å–∏–º—É–º –ø—Ä–∏ ${availableCount} —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö: ${maxAllowed}.`
                );
            }

            if (teamsCount > availableCount) return showError(`–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å ${teamsCount} –∫–æ–º–∞–Ω–¥ –∏–∑ ${availableCount} —á–µ–ª–æ–≤–µ–∫.`);

            try {
                const teams = divideIntoTeamsWithPairs(available, teamsCount);
                if (teams.some(t => t.length === 0)) {
                    throw new Error('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—É—Å—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å —á–∏—Å–ª–æ –∫–æ–º–∞–Ω–¥.');
                }
                renderTeams(teams, subject.name);
            } catch (err) {
                showError('–û—à–∏–±–∫–∞: ' + err.message);
            }
        });
    </script>
</body>
</html>