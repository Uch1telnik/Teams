<script>
const FIXED_PAIR = ['–ì –Ø—Ä–æ—Å–ª–∞–≤ –û', '–ì –ö—Å–µ–Ω–∏—è –ê'];

const SUBJECTS_DATA = {
    geo: {
        name: '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è',
        people: [
            '–ê –ê–ª—å—Ñ–∏–Ω–∞ –ê.', '–ê –ú–∏–ª–∞–Ω–∞ –ê', '–ê –ï–≤–∞ –≠', '–ê –ê–ª–µ–∫—Å–µ–π –ê', '–ë –î–º–∏—Ç—Ä–∏–π –î',
            '–í –ú–∏—Ä—Ä–∞ –ü', '–ì –Ø—Ä–æ—Å–ª–∞–≤ –û', '–ì –ö—Å–µ–Ω–∏—è –ê', '–î –ò–≤–∞–Ω –î', '–î –ù–∞–¥–µ–∂–¥–∞ –ò',
            '–ñ –õ–∞–≤—Ä–µ–Ω—Ç–∏–π –ê', '–ó –í–∞–ª–µ—Ä–∏—è –ê', '–ö –ê–Ω–¥—Ä–µ–π –ù', '–§–∏–ª–∏–ø –û. –ö', '–ö –Ø—Ä–æ—Å–ª–∞–≤ –î',
            '–ü –î–∞—Ä—å—è –ò', '–ú –ê–Ω–∞—Å—Ç–∞—Å–∏—è –°', '–û –ü–∞–≤–µ–ª –ò', '–° –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –Æ', '–° –î–∞–Ω–∏–∏–ª –°',
            '–° –†–æ–º–∞–Ω –°', '–° –§–µ–¥–æ—Ä –ú', '–Æ –î–∞—Ä—å—è –ò', '–Ø –ú–∞—Ç–≤–µ–π –í'
        ],
        fixedPairs: [FIXED_PAIR]
    }
};

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function divideIntoTeamsWithPairs(people, teamsCount, fixedPairs) {
    const peopleSet = new Set(people);
    const teams = Array.from({ length: teamsCount }, () => []);
    const remaining = [...people];

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞—Ä
    for (const [a, b] of fixedPairs) {
        if (peopleSet.has(a) && peopleSet.has(b)) {
            const minTeamIdx = teams.reduce((minIdx, team, idx) =>
                team.length < teams[minIdx].length ? idx : minIdx, 0);
            teams[minTeamIdx].push(a, b);
            const aIndex = remaining.indexOf(a);
            const bIndex = remaining.indexOf(b);
            if (aIndex !== -1) remaining.splice(aIndex, 1);
            if (bIndex !== -1) remaining.splice(bIndex - (aIndex < bIndex ? 1 : 0), 1);
        }
    }

    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
    shuffle(remaining);
    remaining.forEach(person => {
        const minTeamIdx = teams.reduce((minIdx, team, idx) =>
            team.length < teams[minIdx].length ? idx : minIdx, 0);
        teams[minTeamIdx].push(person);
    });

    return teams;
}

function generateTeams(e) {
    e.preventDefault();

    const subjectKey = document.getElementById('subject').value;
    const teamsCount = parseInt(document.getElementById('teams_count').value) || 3;
    const absentInput = document.getElementById('absent').value;

    const subject = SUBJECTS_DATA[subjectKey];
    if (!subject) {
        showError("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç");
        return;
    }

    const allPeople = subject.people;
    const absentList = absentInput.split(',').map(s => s.trim()).filter(s => s);
    const available = allPeople.filter(p => !absentList.includes(p));

    if (available.length === 0) {
        showError("–ù–µ–∫–æ–≥–æ –¥–µ–ª–∏—Ç—å ‚Äî –≤—Å–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.");
        return;
    }
    if (teamsCount > available.length) {
        showError(`–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å ${teamsCount} –∫–æ–º–∞–Ω–¥ –∏–∑ ${available.length} —á–µ–ª–æ–≤–µ–∫.`);
        return;
    }

    const teams = divideIntoTeamsWithPairs(available, teamsCount, subject.fixedPairs);
    renderTeams(teams, subject.name);
    hideError();
}

function renderTeams(teams, subjectName) {
    const container = document.getElementById('results');
    container.innerHTML = `
        <h2>‚úÖ –ö–æ–º–∞–Ω–¥—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É: <em>${subjectName}</em></h2>
        ${teams.map((team, i) => `
            <div class="team">
                <strong>üîπ –ö–æ–º–∞–Ω–¥–∞ ${i + 1} (${team.length}):</strong><br>
                ${team.join(', ')}
            </div>
        `).join('')}
    `;
}

function showError(msg) {
    document.getElementById('error').textContent = msg;
    document.getElementById('error').style.display = 'block';
}

function hideError() {
    document.getElementById('error').style.display = 'none';
}

// –ê–≤—Ç–æ–ø–æ–¥–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ª—é–¥–µ–π –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–µ–¥–º–µ—Ç–∞
document.getElementById('subject').addEventListener('change', function() {
    const subject = SUBJECTS_DATA[this.value];
    document.querySelector('.info-box').innerHTML = `
        <span class="subject-title">${subject.name}:</span>
        ${subject.people.join(', ')}
    `;
});
</script>