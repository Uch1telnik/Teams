<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì –†–∞–∑–¥–µ–ª–∏—Ç—å –∫–ª–∞—Å—Å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã</title>
    <style>
        :root {
            --bg-body: #f9f9fb;
            --bg-container: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #34495e;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --btn-bg: #3498db;
            --btn-hover: #2980b9;
            --team-bg: #e3f2fd;
            --team-border: #2196f3;
            --error-bg: #fdf2f2;
            --error-border: #e74c3c;
            --error-text: #e74c3c;
            --info-bg: #f1f8e9;
            --info-text: #2e7d32;
            --select-bg: #ffffff;
            --warning-bg: #fff8e1;
            --warning-border: #ffc107;
            --warning-text: #5d4037;
        }

        .dark-theme {
            --bg-body: #121212;
            --bg-container: #1e1e1e;
            --text-primary: #f0f0f0;
            --text-secondary: #e0e0e0;
            --border-color: #444;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
            --btn-bg: #1e88e5;
            --btn-hover: #1565c0;
            --team-bg: #1e3a5f;
            --team-border: #4fc3f7;
            --error-bg: #3d2323;
            --error-border: #c62828;
            --error-text: #ef9a9a;
            --info-bg: #2e3b2a;
            --info-text: #a5d6a7;
            --select-bg: #2d2d2d;
            --warning-bg: #332a20;
            --warning-border: #d4af37;
            --warning-text: #e6c39c;
        }

        * {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 30px 20px;
            background-color: var(--bg-body);
            color: var(--text-primary);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--bg-container);
            padding: 25px;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        h1 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-top: 20px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            background-color: var(--select-bg);
            color: var(--text-primary);
        }

        input::placeholder {
            color: #aaa;
        }

        button {
            background: var(--btn-bg);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
            transition: background 0.3s;
        }

        button:hover {
            background: var(--btn-hover);
        }

        .team {
            margin-top: 20px;
            padding: 16px;
            background: var(--team-bg);
            border-left: 5px solid var(--team-border);
            border-radius: 0 6px 6px 0;
            color: var(--text-primary);
        }

        .error {
            color: var(--error-text);
            background: var(--error-bg);
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid var(--error-border);
            margin-top: 15px;
            display: none;
        }

        .warning {
            color: var(--warning-text);
            background: var(--warning-bg);
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid var(--warning-border);
            margin-top: 15px;
            display: none;
            font-size: 0.95em;
        }

        .info-box {
            background: var(--info-bg);
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.95em;
            color: var(--info-text);
        }

        .subject-title {
            color: var(--text-primary);
            font-weight: bold;
        }

        #results {
            margin-top: 30px;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(128, 128, 128, 0.1);
            color: var(--text-primary);
        }

        @media (max-width: 600px) {
            .container { padding: 15px; }
            h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <button id="themeToggle" class="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
        üåû
    </button>

    <div class="container">
        <h1>üéì –†–∞–∑–¥–µ–ª–∏—Ç—å –∫–ª–∞—Å—Å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã</h1>

        <form id="teamForm">
            <label for="subject">üìö –ü—Ä–µ–¥–º–µ—Ç:</label>
            <select id="subject" name="subject" required>
                <option value="geo">–ì–µ–æ–≥—Ä–∞—Ñ–∏—è</option>
            </select>

            <label for="teams_count">üî¢ –ß–∏—Å–ª–æ –∫–æ–º–∞–Ω–¥:</label>
            <input type="number" id="teams_count" name="teams_count" value="3" min="1" required>

            <label for="absent">‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
            <input type="text" id="absent" name="absent"
                   placeholder="–ü—Ä–∏–º–µ—Ä: –ê –ê–ª–µ–∫—Å–µ–π –ê, –í –ú–∏—Ä—Ä–∞ –ü">

            <div class="info-box" id="peopleInfo">
                <span class="subject-title">–ì–µ–æ–≥—Ä–∞—Ñ–∏—è:</span>
                –ê –ê–ª—å—Ñ–∏–Ω–∞ –ê., –ê –ú–∏–ª–∞–Ω–∞ –ê, –ê –ï–≤–∞ –≠, –ê –ê–ª–µ–∫—Å–µ–π –ê, –ë –î–º–∏—Ç—Ä–∏–π –î, –í –ú–∏—Ä—Ä–∞ –ü, –ì –Ø—Ä–æ—Å–ª–∞–≤ –û, –ì –ö—Å–µ–Ω–∏—è –ê, –î –ò–≤–∞–Ω –î, –î –ù–∞–¥–µ–∂–¥–∞ –ò, –ñ –õ–∞–≤—Ä–µ–Ω—Ç–∏–π –ê, –ó –í–∞–ª–µ—Ä–∏—è –ê, –ö –ê–Ω–¥—Ä–µ–π –ù, –§–∏–ª–∏–ø –û. –ö, –ö –Ø—Ä–æ—Å–ª–∞–≤ –î, –ü –î–∞—Ä—å—è –ò, –ú –ê–Ω–∞—Å—Ç–∞—Å–∏—è –°, –û –ü–∞–≤–µ–ª –ò, –° –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –Æ, –° –î–∞–Ω–∏–∏–ª –°, –° –†–æ–º–∞–Ω –°, –° –§–µ–¥–æ—Ä –ú, –Æ –î–∞—Ä—å—è –ò, –Ø –ú–∞—Ç–≤–µ–π –í
            </div>

            <button type="submit">–†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã</button>
        </form>

        <div id="error" class="error"></div>
        <div id="warning" class="warning"></div>
        <div id="results"></div>
    </div>

    <script>
        // === –¢–µ–º–∞ ===
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches;
        let currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');

        function applyTheme(theme) {
            if (theme === 'dark') {
                body.classList.add('dark-theme');
                themeToggle.textContent = 'üåô';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark-theme');
                themeToggle.textContent = 'üåû';
                localStorage.setItem('theme', 'light');
            }
        }
        applyTheme(currentTheme);
        themeToggle.addEventListener('click', () => {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(currentTheme);
        });
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) applyTheme(e.matches ? 'dark' : 'light');
            });
        }

        // === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
        function shuffleArrayInPlace(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }
        function shuffleArray(arr) {
            const copy = [...arr];
            shuffleArrayInPlace(copy);
            return copy;
        }

        // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: —É–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ —á–∏—Å–ª–∞ –∫–æ–º–∞–Ω–¥
        function getAdjustedTeamsCount(availableCount, requested) {
            if (availableCount <= 1) return 1;
            if (availableCount === 2) return 1;
            if (availableCount === 3) return Math.min(requested, 2);
            // –î–ª—è 4+: –º–∞–∫—Å–∏–º—É–º floor(n/2), –Ω–æ –Ω–µ –º–µ–Ω–µ–µ 1 –∏ –Ω–µ –±–æ–ª–µ–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ
            return Math.min(requested, Math.floor(availableCount / 2));
        }

        // üî• –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ì–ê–†–ê–ù–¢–ò–Ø: –ø–æ—Å—Ç-–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ [3,1,0]
        function balanceTeams(teams) {
            // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã
            teams = teams.filter(team => team.length > 0);

            // –ü–æ–∫–∞ –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥–∞ —Å 0 –∏–ª–∏ 1, –∞ –¥—Ä—É–≥–∞—è —Å ‚â•3 ‚Äî –ø–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞–µ–º
            let changed;
            do {
                changed = false;
                const sizes = teams.map(t => t.length);
                const maxIdx = sizes.indexOf(Math.max(...sizes));
                const minIdx = sizes.indexOf(Math.min(...sizes));

                if (teams[maxIdx].length >= 3 && teams[minIdx].length <= 1) {
                    // –ü–µ—Ä–µ–º–µ—Å—Ç–∏–º –æ–¥–Ω–æ–≥–æ –∏–∑ max –≤ min
                    const person = teams[maxIdx].pop();
                    teams[minIdx].push(person);
                    changed = true;
                }
            } while (changed);

            return teams;
        }

        function getRandomMinTeamIndex(teams) {
            const minLength = Math.min(...teams.map(t => t.length));
            const minIndices = teams.map((t, i) => t.length === minLength ? i : -1).filter(i => i !== -1);
            return minIndices[Math.floor(Math.random() * minIndices.length)];
        }

        // === –î–∞–Ω–Ω—ã–µ ===
        const FIXED_PAIR = ['–ì –Ø—Ä–æ—Å–ª–∞–≤ –û', '–ì –ö—Å–µ–Ω–∏—è –ê'];
        const SUBJECTS_DATA = {
            geo: {
                name: '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è',
                people: [
                    '–ê –ê–ª—å—Ñ–∏–Ω–∞ –ê.', '–ê –ú–∏–ª–∞–Ω–∞ –ê', '–ê –ï–≤–∞ –≠', '–ê –ê–ª–µ–∫—Å–µ–π –ê', '–ë –î–º–∏—Ç—Ä–∏–π –î',
                    '–í –ú–∏—Ä—Ä–∞ –ü', '–ì –Ø—Ä–æ—Å–ª–∞–≤ –û', '–ì –ö—Å–µ–Ω–∏—è –ê', '–î –ò–≤–∞–Ω –î', '–î –ù–∞–¥–µ–∂–¥–∞ –ò',
                    '–ñ –õ–∞–≤—Ä–µ–Ω—Ç–∏–π –ê', '–ó –í–∞–ª–µ—Ä–∏—è –ê', '–ö –ê–Ω–¥—Ä–µ–π –ù', '–§–∏–ª–∏–ø –û. –ö', '–ö –Ø—Ä–æ—Å–ª–∞–≤ –î',
                    '–ü –î–∞—Ä—å—è –ò', '–ú –ê–Ω–∞—Å—Ç–∞—Å–∏—è –°', '–û –ü–∞–≤–µ–ª –ò', '–° –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –Æ', '–° –î–∞–Ω–∏–∏–ª –°',
                    '–° –†–æ–º–∞–Ω –°', '–° –§–µ–¥–æ—Ä –ú', '–Æ –î–∞—Ä—å—è –ò', '–Ø –ú–∞—Ç–≤–µ–π –í'
                ],
                fixedPairs: [FIXED_PAIR]
            }
        };

        function divideIntoTeamsWithPairs(people, teamsCount, fixedPairs) {
            const peopleSet = new Set(people);
            const teams = Array.from({ length: teamsCount }, () => []);
            let remaining = [...people];

            // 1. –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä—ã
            for (const [a, b] of fixedPairs) {
                if (peopleSet.has(a) && peopleSet.has(b)) {
                    const teamIdx = getRandomMinTeamIndex(teams);
                    teams[teamIdx].push(a, b);
                    remaining = remaining.filter(p => p !== a && p !== b);
                }
            }

            // 2. –û—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –≤ —Å–ª—É—á–∞–π–Ω—É—é –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é
            const shuffledRemaining = shuffleArray(remaining);
            for (const person of shuffledRemaining) {
                const teamIdx = getRandomMinTeamIndex(teams);
                teams[teamIdx].push(person);
            }

            // 3. –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–∞–Ω–¥
            for (const team of teams) {
                shuffleArrayInPlace(team);
            }

            // 4. ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ê: —É–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º
            return balanceTeams(teams);
        }

        // === UI ===
        function showError(message) {
            document.getElementById('error').textContent = `‚ö†Ô∏è –û—à–∏–±–∫–∞: ${message}`;
            document.getElementById('error').style.display = 'block';
            document.getElementById('warning').style.display = 'none';
        }
        function showWarning(message) {
            document.getElementById('warning').textContent = `‚ÑπÔ∏è ${message}`;
            document.getElementById('warning').style.display = 'block';
        }
        function hideMessages() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('warning').style.display = 'none';
        }
        function renderTeams(teams, subjectName) {
            document.getElementById('results').innerHTML = `
                <h2>‚úÖ –ö–æ–º–∞–Ω–¥—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É: <em>${subjectName}</em></h2>
                ${teams.map((team, i) => `
                    <div class="team">
                        <strong>üîπ –ö–æ–º–∞–Ω–¥–∞ ${i + 1} (${team.length}):</strong><br>
                        ${team.join(', ')}
                    </div>
                `).join('')}
            `;
        }
        function updatePeopleInfo() {
            const subj = SUBJECTS_DATA[document.getElementById('subject').value];
            document.getElementById('peopleInfo').innerHTML =
                `<span class="subject-title">${subj.name}:</span> ${subj.people.join(', ')}`;
        }

        document.getElementById('subject').addEventListener('change', updatePeopleInfo);
        document.getElementById('teamForm').addEventListener('submit', e => {
            e.preventDefault();
            hideMessages();

            const subjectKey = document.getElementById('subject').value;
            let teamsCount = parseInt(document.getElementById('teams_count').value);
            const absentInput = document.getElementById('absent').value.trim();

            if (isNaN(teamsCount) || teamsCount < 1) return showError('–ß–∏—Å–ª–æ –∫–æ–º–∞–Ω–¥ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚â• 1');
            const subject = SUBJECTS_DATA[subjectKey];
            if (!subject) return showError('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç');

            const absentList = absentInput ? absentInput.split(',').map(s => s.trim()).filter(Boolean) : [];
            const available = subject.people.filter(p => !absentList.includes(p));
            const availableCount = available.length;

            if (availableCount === 0) return showError('–ù–µ–∫–æ–≥–æ –¥–µ–ª–∏—Ç—å ‚Äî –≤—Å–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.');

            // üî• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —á–∏—Å–ª–∞ –∫–æ–º–∞–Ω–¥
            const maxAllowed = getAdjustedTeamsCount(availableCount, teamsCount);
            if (teamsCount > maxAllowed) {
                const oldCount = teamsCount;
                teamsCount = maxAllowed;
                showWarning(
                    `–ß–∏—Å–ª–æ –∫–æ–º–∞–Ω–¥ —É–º–µ–Ω—å—à–µ–Ω–æ —Å ${oldCount} –¥–æ ${teamsCount}, ` +
                    `—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–º–∞–Ω–¥ —Å 0‚Äì1 —É—á–∞—Å—Ç–Ω–∏–∫–æ–º. –ú–∞–∫—Å–∏–º—É–º –ø—Ä–∏ ${availableCount} —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö: ${maxAllowed}.`
                );
            }

            if (teamsCount > availableCount) return showError(`–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å ${teamsCount} –∫–æ–º–∞–Ω–¥ –∏–∑ ${availableCount} —á–µ–ª–æ–≤–µ–∫.`);

            try {
                const teams = divideIntoTeamsWithPairs(available, teamsCount, subject.fixedPairs);

                // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ—Ç –ª–∏ –ø—É—Å—Ç—ã—Ö –∫–æ–º–∞–Ω–¥?
                if (teams.some(t => t.length === 0)) {
                    throw new Error('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—É—Å—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å —á–∏—Å–ª–æ –∫–æ–º–∞–Ω–¥.');
                }

                renderTeams(teams, subject.name);
            } catch (err) {
                showError('–û—à–∏–±–∫–∞: ' + err.message);
            }
        });

        updatePeopleInfo();
    </script>
</body>
</html>